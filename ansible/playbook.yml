---
- name: Deploy Laravel application to Yandex Cloud
  hosts: 158.160.150.83
  become: yes
  remote_user: ty9991peterson
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install dependencies
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - curl
        - sqlite3
        - php8.3
        - php8.3-sqlite3
        - php8.3-xml
        - apache2

    - name: Install Docker
      apt:
        name: docker.io
        state: present

    - name: Install Docker Compose
      apt:
        name: docker-compose
        state: present

    - name: Ensure Docker service is running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Clone the repository
      git:
        repo: "https://github.com/MrFiftyFifty/user-crud.git"
        dest: /home/ty9991peterson/user-crud
        version: main

    - name: Build the Docker image
      command: docker build -t user-crud-app /home/ty9991peterson/user-crud

    - name: Run the Docker container
      docker_container:
        name: user-crud-app
        image: user-crud-app
        state: started
        restart_policy: always
        ports:
          - "80:80"

    - name: Ensure Apache is running
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Create Apache config
      copy:
        dest: /etc/apache2/sites-available/hexletJob.conf
        content: |
          <VirtualHost *:80>
              ServerName 158.160.150.83
              DocumentRoot /home/ty9991peterson/user-crud/public
              <Directory /home/ty9991peterson/user-crud/public>
                  Options Indexes FollowSymLinks
                  AllowOverride All
                  Require all granted
              </Directory>
              ErrorLog ${APACHE_LOG_DIR}/error.log
              CustomLog ${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>

    - name: Enable Apache site
      command: a2ensite hexletJob

    - name: Enable Apache rewrite module
      command: a2enmod rewrite

    - name: Restart Apache
      service:
        name: apache2
        state: restarted
